<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Read â€” Terminal Notes</title>
    <!-- é˜²æ­¢é¡µé¢é—ªçƒ -->
    <script>
      (function() {
        const saved = localStorage.getItem('tn_mode') || 'mode-light';
        const isLight = saved === 'mode-light';
        const root = document.documentElement;
        root.classList.toggle('mode-light', isLight);
        root.classList.toggle('mode-dark', !isLight);
      })();
    </script>
  <link rel="stylesheet" href="./style.css" />
  <link rel="stylesheet" href="./parser/markdown.css" />
  <link rel="stylesheet" href="./parser/html.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" />
  </head>
  <body>
  <button id="header-btn" class="header-btn" title="åˆ‡æ¢æ˜æš—" aria-label="toggle theme">ğŸŒ—</button>
    <div class="reader">
  <div class="toolbar">
        <button id="terminal-btn" class="terminal-btn" title=">_ Terminal" aria-label=">_ Terminal"></button>
        <div id="path" class="muted"></div>
      </div>
  <article id="content" class="reader-content markdown-body" data-theme="dark"></article>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <script>
      (async function () {
        // Apply same mode as index.html
        const modeKey = 'tn_mode';
        const root = document.documentElement;
        const saved = localStorage.getItem(modeKey) || 'mode-light';
        const isLight = saved === 'mode-light';
        
        root.classList.toggle('mode-light', isLight);
        root.classList.toggle('mode-dark', !isLight);
        
        const contentEl = document.getElementById('content');
        contentEl?.setAttribute('data-theme', isLight ? 'light' : 'dark');
        
        const headerBtn = document.getElementById('header-btn');
        // é˜…è¯»å™¨ï¼šæµ®åŠ¨æŒ‰é’®ä¸é¦–é¡µä¸€è‡´ï¼Œç”¨äºæ˜æš—åˆ‡æ¢
        if (headerBtn) {
          headerBtn.textContent = 'ğŸŒ—';
          headerBtn.title = 'åˆ‡æ¢æ˜æš—';
          headerBtn.onclick = (e) => {
            e.preventDefault();
            const newIsLight = !root.classList.contains('mode-light');
            document.querySelectorAll('html, body, #app').forEach(el => {
              el.classList.toggle('mode-light', newIsLight);
              el.classList.toggle('mode-dark', !newIsLight);
            });
            localStorage.setItem(modeKey, newIsLight ? 'mode-light' : 'mode-dark');
            contentEl?.setAttribute('data-theme', newIsLight ? 'light' : 'dark');
          };
        }

        // å·¥å…·æ ä¸­çš„ Terminal è¿”å›æŒ‰é’®
        const terminalBtn = document.getElementById('terminal-btn');
        if (terminalBtn) {
          terminalBtn.innerHTML = '&gt;<span class="btn-underscore" aria-hidden="true"></span>';
        }
        
  const params = new URLSearchParams(location.search);
  const file = params.get('file');
  const from = params.get('from') || 'notes';
        
        if (!file) {
          contentEl.textContent = 'ç¼ºå°‘ file å‚æ•°';
          return;
        }
        
        const pathEl = document.getElementById('path');
  // ä½¿ç”¨ç»Ÿä¸€çš„ header æŒ‰é’®è¿›è¡Œè¿”å›åŠ¨ä½œï¼Œå·²åœ¨ä¸Šæ–¹ç»‘å®š
        if (terminalBtn) {
          terminalBtn.onclick = (e) => {
            e.preventDefault();
            location.href = './index.html?path=' + encodeURIComponent(from);
          };
        }
        
        // Display path in ~ format for consistency with terminal
        const displayPath = file.startsWith('notes/') ? '~' + file.slice(5) : file;
        pathEl.textContent = displayPath;
        
        try {
          const isMD = /\.md$/i.test(file);
          const res = await fetch('./' + file);
          if (!res.ok) throw new Error('æ— æ³•åŠ è½½: ' + file);
          const txt = await res.text();
          
          if (isMD) {
            contentEl.innerHTML = marked.parse(txt, { mangle: false, headerIds: false });
          } else {
            contentEl.innerHTML = txt;
          }
          
          if (window.Prism) {
            Prism.highlightAllUnder(contentEl);
          }
        } catch (err) {
          contentEl.textContent = String(err);
        }
      })();
    </script>
    <!-- é¡µé¢åŠ è½½å®Œæˆæ ‡è®° -->
    <script>
      // ç»Ÿä¸€é¡µé¢åŠ è½½å®Œæˆæ ‡è®°
      document.addEventListener('DOMContentLoaded', function() {
        document.documentElement.classList.add('loaded');
      });
      // å¤„ç†ä» bfcache æ¢å¤ï¼šè¡¥ä¸€æ¬¡ä»£ç é«˜äº®ä»¥ç¡®ä¿ä¸€è‡´
      window.addEventListener('pageshow', function() {
        const contentEl = document.getElementById('content');
        if (window.Prism && contentEl) {
          Prism.highlightAllUnder(contentEl);
        }
      });
    </script>
  </body>
  </html>
